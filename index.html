<!DOCTYPE html>
<meta charset="utf-8" />
<meta
  name="viewport"
  content="width=device-width, initial-scale=1, shrink-to-fit=no"
/>
<title>Positive Predictive Value</title>

<script src="https://d3js.org/d3.v5.min.js"></script>
<script src="https://unpkg.com/d3-simple-slider"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/3.10.1/lodash.min.js" charset="utf-8"></script>

<div class="container">
  <div id="sliders-container">
    <div id="slider-container">
      <div id='infection-rate-slider'>
        <span class="slider-title">Infection Rate: </span>
        <span id="value-infection"></span>
        <div id="slider-infection"></div>
      </div>
    </div>
    <div class="slider-container">
      <div id='false-positive-rate-slider'>
        <span class="slider-title">False Positive Rate: </span>
        <span id="value-falsepositive"></span>
        <div id="slider-falsepositive"></div>
      </div>
    </div>
  </div>
  <div id="graphics-container">
    <div id='population-box'>
    </div>
  </div>
  <div id="values-container">
    <div id='pos-pred-value-container'>
      <span class="value-title">Positive Predictive Value: </span>
      <span id='pos-pred-value'>
    </div>
  </div>
</div>
<script src="sliders.js" charset="utf-8"></script>
<script src="d3_population_grid.js" charset="utf-8"></script>

<script>
// color boxes based on slider values
trueNegColor = '#d9d9d9' //gray
truePosColor = '#e31a1c' //red
falsePosColor = '#feb24c' //orange

function shuffle(array) {
  var copy = [], n = array.length, i;
  // While there remain elements to shuffle…
  while (n) {
    // Pick a remaining element…
    i = Math.floor(Math.random() * array.length);
    // If not already shuffled, move it to the new array.
    if (i in array) {
      copy.push(array[i]);
      delete array[i];
      n--;
    }
  }
  return copy;
}

var boxIndices = d3.range(1, numBoxes + 1, 1);
shuffledIndices = shuffle(boxIndices);

var truePositivesIx = [],
    trueNegativesIx = [],
    falsePositivesIx = [],
    falseNegativesIx = [];

var iRate, fpRate, fnRate, numInfected, numHealthy,
    numFP, numTP, numTN, numFN, posPredictiveValue;

updateAll();

infectedRateSlider.on('onchange', function spit(d) {
  d3.select('#value-infection').text(d3.format('.1%')(infectedRateSlider.value()));
  updateAll();
})

falsePosSlider.on('onchange', function spit(d) {
  d3.select('#value-falsepositive').text(d3.format('.1%')(falsePosSlider.value()));
  updateAll();
})

function computeRates() {
  iRate = infectedRateSlider.value();
  fpRate = falsePosSlider.value();
  fnRate = 0;
  numInfected = iRate * numBoxes;
  numHealthy = numBoxes - numInfected;
  numFP = fpRate * numHealthy;
  numTP = numInfected;
  numTN = numHealthy - numFP;
  numFN = 0;
  posPredictiveValue = (1 - fnRate) * iRate / (iRate * (1 - fnRate) + (1 - iRate) * fpRate)
}

function updatePosPredVal(){
  d3.select('#pos-pred-value').text(d3.format('.1%')(posPredictiveValue));
}


function updateBoxes() {
  // update box indices
  truePositivesIx = shuffledIndices.slice(0, numTP);
  trueNegativesIx = shuffledIndices.slice(numTP, numTP + numTN);
  falsePositivesIx = shuffledIndices.slice(numTN + numTP, );
  // falseNegatives = boxIndices.slice(numTN, numTN + numTP);

  // color healthy gray
  colorBoxes(trueNegativesIx, trueNegColor)
  // color infected red
  colorBoxes(truePositivesIx, truePosColor)
  // color false positives yellow
  colorBoxes(falsePositivesIx, falsePosColor)
}

function updateAll(){
  computeRates();
  updateBoxes();
  updatePosPredVal();
}

function colorBoxes(boxArray, clr) {
  boxArray.forEach(function(ix){
    d3.select("#s-"+ix).attr("fill", clr);
  })
}

</script>
<style type="text/css">

  .slider-title {
    font-weight: normal;
  }

  .value-title, #pos-pred-value {
    font-size: 14pt;
  }
  #pos-pred-value {font-weight: bold}

  #sliders-container {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-around;
    margin: 5px;
    align-content: center;
    align-items: center;
  }

  #slider-container {
    margin: 10px;
  }

  #graphics-container, #values-container {
    /* width: 600px; */

    display: flex;
    flex-wrap: wrap;
    align-content: center;
    justify-content: space-around;
    margin: 15px;
  }

  .rect {
    padding: 2px;
  }



</style>
