<!DOCTYPE html>
<meta charset="utf-8" />
<meta
  name="viewport"
  content="width=device-width, initial-scale=1, shrink-to-fit=no"
/>
<title>Positive Predictive Value</title>

<script src="https://d3js.org/d3.v5.min.js"></script>
<script src="https://unpkg.com/d3-simple-slider"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/3.10.1/lodash.min.js" charset="utf-8"></script>

<div class="container">
  <div id="sliders-container">
    <div id="slider-container">
      <div id='infection-rate-slider'>
        <span class="slider-title">Infection Rate: </span>
        <span id="value-infection"></span>
        <div id="slider-infection"></div>
      </div>
    </div>
    <div class="slider-container">
      <div id='false-positive-rate-slider'>
        <span class="slider-title">False Positive Rate: </span>
        <span id="value-falsepositive"></span>
        <div id="slider-falsepositive"></div>
      </div>
    </div>
    <div class="slider-container">
      <div id='false-negative-rate-slider'>
        <span class="slider-title">False Negative Rate: </span>
        <span id="value-falsenegative"></span>
        <div id="slider-falsenegative"></div>
      </div>
    </div>
  </div>
  <div id="graphics-container">
    <div id='population-container'>
      <div id='population-title'>
        Population Test Results
      </div>
      <div id='population-box'></div>
    </div>
    <div id='positives-container'>
      <div id='positives-title'>
        Positive Test Results Only
      </div>
      <div id='positives-graphics'>
        <div id='true-pos-block'>
          <div id='true-positives-box'></div>
          <div id='true-pos-box-text'>
            True positives
          </div>
        </div>
        <div id='false-pos-block'>
          <div id='false-positives-box'></div>
          <div id='false-pos-box-text'>
            False positives
          </div>
        </div>
      </div>
      <div id="values-container">
        <div id='pos-pred-value-container'>
          <span class="value-title">Positive Predictive Value: </span>
          <span id='pos-pred-value'>
        </div>
      </div>
    </div>
  </div>
</div>
<script src="sliders.js" charset="utf-8"></script>
<script src="makeGrid.js" charset="utf-8"></script>

<script>
// color boxes based on slider values
trueNegColor = '#d9d9d9' //gray
truePosColor = '#e31a1c' //red
falsePosColor = '#feb24c' //orange

// population grid
var numRows = 25, numCols = 40, numBoxes = numCols * numRows;
makeGrid(numRows, numCols, '#population-box', 'pop-')

var numRowsTP = 20, numColsTP = 5, numBoxesTP = numColsTP * numRowsTP;
makeGrid(numRowsTP, numColsTP, '#true-positives-box', 'tp-', fillColor='#ffffff')

var numRowsFP = 20, numColsFP = 5, numBoxesFP = numColsFP * numRowsFP;
makeGrid(numRowsFP, numColsFP, '#false-positives-box', 'tn-', fillColor='#ffffff')

function shuffle(array) {
  var copy = [], n = array.length, i;
  // While there remain elements to shuffle…
  while (n) {
    // Pick a remaining element…
    i = Math.floor(Math.random() * array.length);
    // If not already shuffled, move it to the new array.
    if (i in array) {
      copy.push(array[i]);
      delete array[i];
      n--;
    }
  }
  return copy;
}

var boxIndices = d3.range(1, numBoxes + 1, 1);
shuffledIndices = shuffle(boxIndices);

var iRate, fpRate, fnRate, numInfected, numHealthy,
    numFP, numTP, numTN, numFN, posPredictiveValue;

var truePosBoxIndices = d3.range(1, numBoxesTP + 1, 1);
var falsePosBoxIndices = d3.range(1, numBoxesFP + 1, 1);

updateAll();

infectedRateSlider.on('onchange', function spit(d) {
  d3.select('#value-infection').text(d3.format('.1%')(infectedRateSlider.value()));
  updateAll();
})

falsePosSlider.on('onchange', function spit(d) {
  d3.select('#value-falsepositive').text(d3.format('.1%')(falsePosSlider.value()));
  updateAll();
})

falseNegSlider.on('onchange', function spit(d) {
  d3.select('#value-falsenegative').text(d3.format('.0%')(falseNegSlider.value()));
  updateAll();
})

function computeRates() {
  iRate = infectedRateSlider.value();
  fpRate = falsePosSlider.value();
  fnRate = falseNegSlider.value();
  numInfected = iRate * numBoxes;
  numHealthy = numBoxes - numInfected;
  numFP = fpRate * numHealthy;
  numTN = numHealthy - numFP;
  numFN = fnRate * numInfected;
  numTP = numInfected - numFN;
  posPredictiveValue = (1 - fnRate) * iRate / (iRate * (1 - fnRate) + (1 - iRate) * fpRate)
}

function updatePosPredVal(){
  d3.select('#pos-pred-value').text(d3.format('.1%')(posPredictiveValue));
}


function updateBoxes() {
  // update box indices
  falseNegativesIx = shuffledIndices.slice(0, numFN);
  truePositivesIx = shuffledIndices.slice(numFN, numFN + numTP);
  trueNegativesIx = shuffledIndices.slice(numFN + numTP, numFN + numTP + numTN);
  falsePositivesIx = shuffledIndices.slice(numFN + numTP + numTN, );

  // color healthy
  colorBoxes(trueNegativesIx, trueNegColor, '#ffffff', 'pop-')
  // color infected
  colorBoxes(truePositivesIx, truePosColor, '#ffffff', 'pop-')
  // color false positives
  colorBoxes(falsePositivesIx, falsePosColor, '#ffffff', 'pop-')
  // false negatives
  colorBoxes(falseNegativesIx, trueNegColor, truePosColor, 'pop-')
}

function updatePosBoxes() {
  truePosBoxIx = truePosBoxIndices.slice(numBoxesTP - numTP, );
  notTruePosBoxIx = truePosBoxIndices.slice(0, numBoxesTP - numTP);

  falsePosBoxIx = falsePosBoxIndices.slice(numBoxesFP - numFP, );
  notFalsePosBoxIx = falsePosBoxIndices.slice(0, numBoxesFP - numFP);

  colorBoxes(truePosBoxIx, truePosColor,'#ffffff', 'tp-');
  colorBoxes(notTruePosBoxIx, '#ffffff','#ffffff', 'tp-');

  colorBoxes(falsePosBoxIx, falsePosColor,'#ffffff', 'tn-');
  colorBoxes(notFalsePosBoxIx, '#ffffff','#ffffff', 'tn-');
}

function updateAll(){
  computeRates();
  updateBoxes();
  updatePosBoxes();
  updatePosPredVal();
}

function colorBoxes(boxArray, clr, clroutside, boxPrefix) {
  boxArray.forEach(function(ix){
    d3.select('#' + boxPrefix + ix).attr("fill", clr).attr("stroke", clroutside);
  })
}

</script>
<style type="text/css">

  .slider-title {
    font-weight: normal;
  }

  .value-title, #pos-pred-value {
    font-size: 14pt;
  }
  #pos-pred-value {font-weight: bold}

  #sliders-container {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-around;
    margin: 5px;
    align-content: center;
    align-items: center;
  }

  #slider-container {
    margin: 10px;
  }

  #graphics-container, #values-container, #positives-graphics {
    /* width: 600px; */

    display: flex;
    flex-wrap: wrap;
    align-content: center;
    justify-content: space-around;
    margin: 10px;
  }

  #true-positives-box, #false-positives-box
   {
    margin: 10px;
  }

  .rect {
    padding: 2px;
  }
  #positives-title, #population-title {
    text-align: center;
    font-weight: bold;
    font-size: 14pt;
    margin: 10px;
  }

</style>
